<?php
declare(strict_types=1);

namespace app\home\user;

use app\common\controllers\BaseUser;
use app\model\user\UserPointsLog;
use think\db\exception\DbException;
use think\template\exception\TemplateNotFoundException;

class PointsLog extends BaseUser
{
    /**
     * @var array|string[]
     */
    protected array $search;
    /**
     * @var array
     */
    protected array $tables;
    /**
     * 是否开启分页
     * @var bool
     */
    protected bool $is_page = true;

    protected function initialize(): void
    {
        parent::initialize(); // TODO: Change the autogenerated stub
        $this->setParams();
    }

    /**
     * @return string
     * @throws DbException
     */
    public function index(): string
    {
        if ($this->isLayTable()) {
            $data = UserPointsLog::where('uid', $this->user['id'])->order('id desc')->paginate(20)->toArray();
            $this->success($data);
        }
        //渲染页面
        try {
            return $this->fetch();
        } catch (TemplateNotFoundException $exception) {
            //模板不存在时 尝试读取公用模板
            return $this->fetch('common@page_table');
        }
    }

    /**
     * @return void
     */
    protected function setParams(): void
    {
        // 定义表格字段
        $this->tables['fields'] = [
            [
                'field' => 'points',
                'title' => '积分变动',
                'width' => 100,
            ],
            [
                'field' => 'type',
                'title' => '变动类型',
                'width' => 150,
            ],
            [
                'field' => 'description',
                'title' => '变动描述',
                'type' => 'textarea',
            ],
            [
                'field' => 'create_time',
                'title' => '创建时间',
                'width' => 200,
                'sort' => true,
            ],
        ];

//        // 定义表单字段
//        $this->forms['fields'] = [
//            [
//                'type' => 'text',
//                'name' => 'uid',
//                'label' => '用户ID',
//                'readonly' => true,
//            ],
//            [
//                'type' => 'number',
//                'name' => 'points',
//                'label' => '积分变动',
//                'readonly' => true,
//            ],
//            [
//                'type' => 'text',
//                'name' => 'type',
//                'label' => '变动类型',
//                'readonly' => true,
//            ],
//            [
//                'type' => 'textarea',
//                'name' => 'desc',
//                'label' => '变动描述',
//                'readonly' => true,
//            ],
//            [
//                'type' => 'datetime',
//                'name' => 'create_time',
//                'label' => '创建时间',
//                'readonly' => true,
//            ],
//        ];

        // 定义搜索条件
        $this->search = [
            'id#=#id',
            'username#like#username',
            'points#=#points',
            'type#like#type',
            'create_time#between#create_time',
        ];
    }
}
